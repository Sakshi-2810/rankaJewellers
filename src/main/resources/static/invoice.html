<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Invoice Center | Ranka Jewellers</title>
<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Dancing+Script:wght@600&family=Poppins:wght@300;400;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<style>
    /* ===============================
   ITEM ROW TYPOGRAPHY ENHANCEMENTS
================================= */

/* Base font refinement */
table {
    font-size: 12px;
}
td:nth-child(9) {
    white-space: nowrap !important;
    text-align: center;
}
/* Item description should stand out */
td:nth-child(2) input {
    font-size: 75%;
    font-weight: 500;
    letter-spacing: 0.2px;
}

/* HSN & Purity – compact and subtle */
.item-hsn,
.item-purity {
    font-size: 75%;
    text-align: center;
    color: #555;
}

/* Quantity & Weight – numeric clarity */
.item-qty,
.weight {
    font-family: "Courier New", monospace;
    font-size: 12px;
    text-align: center;
}

/* Monetary values – aligned & readable */
.m-val,
.making-val,
.row-total {
    font-family: "Courier New", monospace;
    font-size: 12px;
    font-weight: 600;
}

/* Metal dropdown refinement */
.type-select {
    font-size: 11px;
    padding: 6px 8px;
    text-align: center;
}

/* Row spacing for breathing room */
tbody tr {
    height: 44px;
}

/* ===============================
   MOBILE OPTIMIZATION (ITEMS)
================================= */
@media screen and (max-width: 768px) {

    table {
        font-size: 11px;
    }

    /* Allow description to wrap */
    td:nth-child(2) input {
        white-space: normal;
        line-height: 1.3;
        font-size: 12px;
    }

    /* Tighten numeric fields */
    .item-qty,
    .weight {
        font-size: 11px;
        padding: 4px;
    }

    /* Reduce monetary column width visually */
    .m-val,
    .making-val,
    .row-total {
        font-size: 11px;
    }

    /* Hide purity text visually but keep data */
    .item-purity {
        opacity: 0.7;
    }
}


:root { 
    --gold: #d4af37;
    --gold-dark: #b8962e;
    --gold-primary: #b08d57;
    --gold-light: #f4ece1;

    --silver: #cfd2d6;
    --silver-dark: #9da3a8;

    --text-main: #2d3436;
    --bg-body: #f4f1ea;
    --dark-sidebar: #1a1a1a;

    --transition: all 0.35s ease;
}


* { box-sizing: border-box; font-family: 'Poppins', sans-serif; }

body { 
    display: flex;
    height: 100vh;
    margin: 0;
    background: var(--bg-body);
    color: var(--text-main);
    overflow: hidden; 
}
  /* ===== SIDEBAR ===== */
        .sidebar {
            width: 270px;
            background: linear-gradient(180deg, #0c0c0c, #1a1a1a);
            padding: 45px 0;
            display: flex;
            flex-direction: column;
            box-shadow: 8px 0 30px rgba(0,0,0,0.4);
        }

        .sidebar-brand {
            text-align: center;
            padding-bottom: 50px;
        }

        .sidebar-brand h1 {
            font-family: 'Great Vibes', cursive;
            font-size: 3rem;
            color: var(--gold);
            margin: 0;
            letter-spacing: 2px;
        }

        .sidebar-brand span {
            display: block;
            font-family: 'Playfair Display', serif;
            font-size: 0.75rem;
            letter-spacing: 4px;
            text-transform: uppercase;
            color: var(--silver);
            margin-top: 8px;
        }

        .nav-menu {
            padding: 0 20px;
            flex-grow: 1;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 14px 20px;
            border-radius: 14px;
            color: var(--silver);
            text-decoration: none;
            margin-bottom: 10px;
            transition: var(--transition);
            font-size: 0.9rem;
        }

        .nav-item i {
            font-size: 1.1rem;
            width: 22px;
            text-align: center;
        }

        .nav-item:hover {
            background: rgba(212,175,55,0.12);
            color: var(--gold);
        }

        .nav-item.active {
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: #fff;
            box-shadow: 0 10px 30px rgba(212,175,55,0.35);
        }

/* --- MAIN CONTENT --- */
.main-content { flex-grow: 1; overflow-y: auto; padding: 20px; display: block; }
.invoice-box { 
    max-width: 950px; margin: 20px auto; padding: 40px; 
    background: #fff; border-radius: 12px; 
    box-shadow: 0 10px 30px rgba(0,0,0,0.05);
    border: 1px solid rgba(176, 141, 87, 0.2);
    overflow: visible;
}
.shop-info { 
    flex-grow: 1;
    text-align: center;
    margin-left: 20px;
}
.row-header { 
    display: flex; 
    align-items: center; /* Align to top */
    justify-content: flex-start; /* This pushes elements to the edges */
    border-bottom: 2px solid var(--gold-light); 
    padding-bottom: 15px; 
    margin-bottom: 15px; 
}
.shop-info h1 { font-family: 'Great Vibes', cursive; margin: 0; color: var(--gold-primary); font-size: 54px; font-weight: 400; }
.shop-info p { font-size: 11px; color: #636e72; margin: 2px 0; text-transform: uppercase; letter-spacing: 1px;}

.inv-meta-bar { 
    display: flex; 
    justify-content: space-between; 
    align-items: center;
    margin-top: 10px; 
    padding: 8px 10px;
    font-family: 'Dancing Script', cursive; 
    font-size: 14px; 
    color: var(--gold-primary); 
    /* The line at the end */
    border-bottom: 1.5px solid var(--gold-light); 
    margin-bottom: 15px;
}
.inv-meta-bar div {
    display: flex;
    align-items: center;
    gap: 8px;
}

.inv-meta-bar input { 
    border: none; 
    font-weight: bold; 
    background: transparent; 
    width: 140px; 
    font-size: 10px; 
    font-family: 'Poppins', sans-serif;
    color: var(--text-main);
}
.info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; }
.section-label { font-size: 10px; font-weight: 600; text-transform: uppercase; color: var(--gold-primary); letter-spacing: 1px; margin-bottom: 4px; display: block; }

input, textarea, select { width: 100%; border: 1px solid #edf2f7; padding: 8px; border-radius: 6px; font-size: 75%; }
input:required { border-left: 3px solid var(--gold-primary); }

.live-rates { background: var(--gold-light); padding: 12px; border-radius: 8px; display: flex; gap: 15px; align-items: center; margin-bottom: 15px; border: 1px solid #e2d1b8; }

table { width: 100%; border-collapse: collapse; margin: 10px 0; }
th { background: #fafbfc; padding: 10px; text-align: left; font-size: 10px; color: #a0aec0; text-transform: uppercase; border-bottom: 2px solid var(--gold-light); }
td { padding: 8px 10px; border-bottom: 1px solid #f1f4f8; }

.gold-theme { background-color: #fffcf0 !important; color: #8a6d07 !important; border: 1px solid var(--gold-primary) !important; font-weight: 600; }
.silver-theme { background-color: #f8fafc !important; color: #4a5568 !important; border: 1px solid #ddd !important; }

.footer-section { display: grid; grid-template-columns: 1.2fr 1fr; gap: 40px; margin-top: 20px; }
.amount-words { margin: 15px 0; padding: 12px; background: var(--gold-light); border-radius: 8px; font-family: 'Dancing Script', cursive; font-size: 18px; color: #8a6d07; border-left: 5px solid var(--gold-primary); }

.summary-table div { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #f1f4f8; }
.grand-total-row { font-size: 22px; font-weight: 600; color: var(--gold-primary); border-top: 2px solid var(--gold-primary) !important; padding: 10px 0 !important; }

.signature-box { margin-top: 40px; text-align: center; }
.signature-line { border-top: 1px solid #333; width: 160px; display: inline-block; }
.sign-label { font-family: 'Dancing Script', cursive; font-size: 18px; display: block; color: #8a6d07; }

.btn-group { display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; margin-top: 25px; }
.btn { padding: 10px 20px; border-radius: 50px; cursor: pointer; border: none; font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; transition: 0.2s; text-decoration: none; display: inline-block; text-align: center;}
.btn-add { background: var(--gold-primary); color: white; }
.btn-print { background: #2d3436; color: white; }
.btn-save { background: #27ae60; color: white; }

#globalLoader .loader-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center; }
.spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--gold-primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
@page {
    size: A4;
    margin: 0; 
}

@media print {

    * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }

    html, body {
        margin: 0;
        padding: 0;
        height: auto !important;
        overflow: visible !important;
    }

    /* Remove sidebar + buttons */
    .sidebar, .no-print, .btn-group {
        display: none !important;
    }

    .main-content {
        padding: 0 !important;
        margin: 0 !important;
    }

    /* Reduce A4 page inner padding to fit more rows */
    .invoice-box {
        padding: 12mm !important;      /* previously ~15mm → now tighter */
        border: none !important;
        box-shadow: none !important;
        background: white !important;
        min-height: auto !important;
        position: relative;
    }

    /* Light design background */
    .invoice-box::before {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        z-index: -1;
        background:
            repeating-linear-gradient(
                45deg,
                rgba(0,0,0,0.02) 0,
                rgba(0,0,0,0.02) 1px,
                transparent 1px,
                transparent 10px
            ),
            repeating-linear-gradient(
                -45deg,
                rgba(0,0,0,0.02) 0,
                rgba(0,0,0,0.02) 1px,
                transparent 1px,
                transparent 10px
            ),
            linear-gradient(180deg, #fff 0%, #fafafa 100%);
    }

    /* Reduce header spacing */
    .row-header {
        margin-bottom: 8px !important;
        padding-bottom: 6px !important;
    }

    .shop-info h1 {
        font-size: 38px !important;
    }

    table {
        table-layout: fixed !important;
        width: 100% !important;
        border-collapse: collapse !important;
        font-size: 10px !important; /* Reduced */
    }

    th {
        padding: 4px !important;        /* Was 10px */
        font-size: 9px !important;      /* Was 10px */
    }

    td {
        padding: 4px 6px !important;    /* Was 8px 10px */
        font-size: 10px !important;
        height: 24px !important;        /* CRITICAL: smaller row height */
        line-height: 1.2 !important;
        border-bottom: 1px solid #eee !important;
    }

    tbody tr {
        height: 24px !important;        /* Forces compact print height */
        page-break-inside: avoid !important;
    }

    /* Reduce input size inside cells */
    td input,
    td select {
        font-size: 10px !important;
        padding: 0 !important;
        margin: 0 !important;
        height: 18px !important;
        background: transparent !important;
        border: none !important;
    }

    /* Numeric fields remain readable */
    input.item-qty,
    input.weight,
    input.item-hsn,
    input.item-purity {
        text-align: center !important;
    }

    /* Summary spacing tighten */
    .footer-section {
        margin-top: 10px !important;
        gap: 20px !important;
    }

    .amount-words {
        font-size: 14px !important;
        padding: 8px !important;
    }

    .signature-box {
        margin-top: 25px !important;
    }

    .invoice-watermark {
        font-size: 60px !important;
    }
    /* Entire rate bar shrinks */
    .live-rates {
        padding: 4px 6px !important;     /* Was ~12px */
        margin: 4px 0 8px 0 !important;  /* Reduce vertical space */
        border: 1px solid #ddd !important;
        background: #fff !important;
        border-radius: 4px !important;
        font-size: 9px !important;
        gap: 6px !important;
        align-items: center !important;
        line-height: 1.1 !important;
    }

    /* Ensure items stay on single line */
    .live-rates > div,
    .live-rates span,
    .live-rates input {
        font-size: 9px !important;
        margin: 0 !important;
        padding: 0 !important;
        white-space: nowrap !important;
    }

    /* Make rate input boxes tiny but readable */
    .live-rates input {
        width: 50px !important;
        height: 16px !important;
        border: 1px solid #ccc !important;
        text-align: center !important;
        background: white !important;
        padding: 0 !important;
        font-size: 9px !important;
    }

    /* Remove gold/silver theme color blocks in print */
    .gold-theme,
    .silver-theme {
        background: none !important;
        color: #000 !important;
        border: none !important;
        font-weight: 500 !important;
    }
}

/* 1. Remove the up/down arrows (spinners) to free up horizontal space */
.weight::-webkit-outer-spin-button,
.weight::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

/* 2. Reduce horizontal padding and ensure the font fits */
.weight {
    padding-left: 4px !important;
    padding-right: 4px !important;
    text-align: center; /* Optional: centers the value for better visibility */
}

/* 3. Ensure the table column has enough room (Overriding the 10% if needed) */
th:nth-child(5), 
td:nth-child(5) {
    min-width: 85px !important; 
}
/* ===== RESPONSIVE MEDIA QUERIES ===== */

/* Tablet View (up to 1024px) */
@media screen and (max-width: 1024px) {
    body {
        flex-direction: column;
        overflow-y: auto;
    }

    .sidebar {
        width: 100%;
        height: auto;
        padding: 20px 0;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .sidebar-brand {
        padding-bottom: 0;
        padding-left: 30px;
        text-align: left;
    }

    .sidebar-brand h1 { font-size: 2rem; }

    .nav-menu {
        display: flex;
        padding: 0 20px;
        gap: 8px;
    }

    .nav-item {
        margin-bottom: 0;
        padding: 10px 15px;
        font-size: 0.8rem;
    }

    .main-content {
        padding: 20px;
    }

    .invoice-box {
        padding: 25px;
        width: 100%;
    }
}

/* Mobile View (up to 768px) */
@media screen and (max-width: 768px) {
    .sidebar {
        flex-direction: column;
        gap: 10px;
    }

    .nav-menu {
        width: 100%;
        overflow-x: auto;
        padding: 5px 15px;
        justify-content: flex-start;
    }

    /* Stack Info Grid (Customer Details) */
    .info-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }

    /* Live Rates wrapping */
    .live-rates {
        flex-wrap: wrap;
        justify-content: center;
        font-size: 12px;
    }

    /* Table Responsiveness: Enable horizontal scroll */
    .invoice-box {
        overflow-x: hidden; /* Prevent box from breaking */
    }

    table {
        display: block;
        overflow-x: auto;
        white-space: nowrap; /* Keeps columns from squishing */
        -webkit-overflow-scrolling: touch;
    }

    /* Stack Footer (Terms and Summary) */
    .footer-section {
        grid-template-columns: 1fr;
        gap: 20px;
    }

    .shop-info h1 {
        font-size: 40px;
    }

    .grand-total-row {
        font-size: 18px;
    }

    .inv-meta-bar {
        flex-direction: column;
        gap: 10px;
        align-items: center;
    }
}

/* Adjustments for small phones */
@media screen and (max-width: 480px) {
    .btn-group {
        flex-direction: column;
    }
    
    .btn {
        width: 100%;
    }
}
/* Styling for Making Charge Input */
.making-val-input {
    display: inline-block !important;
    width: 35px !important; /* Fixed width to ensure % fits beside it */
    border: 1px solid #edf2f7;
    padding: 2px;
    text-align: right;
}

/* Bank Details Box */
.bank-details-box {
    margin-top: 15px;
    padding: 12px;
    border: 1px solid var(--gold-light);
    border-radius: 8px;
    background: #fffdf9;
    display: flex; /* Added flex */
    align-items: center;
    gap: 20px; /* Space between QR and Text */
}

.bank-details-box span {
    display: block;
    font-size: 11px;
    color: #555;
    line-height: 1.6;
}

.bank-details-title {
    font-weight: 600;
    color: var(--gold-primary);
    text-transform: uppercase;
    font-size: 10px;
    letter-spacing: 1px;
    margin-bottom: 5px;
    display: block;
}
/* Left side text */
.bank-left span {
    display: block;
    font-size: 11px;
    color: #555;
    line-height: 1.6;
}

/* QR Right Side */
.bank-qr {
    text-align: center;
    flex-shrink: 0;
}

.bank-qr img {
    width: 110px;
    height: 110px;
    object-fit: contain;
    border: 1px solid #eee;
    border-radius: 6px;
    padding: 4px;
    background: white;
}

.qr-text {
    font-size: 9px;
    color: #777;
    margin-top: 3px;
    display: block;
}
</style>
</head>
<body>

  <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="sidebar-brand">
            <h1>Ranka</h1>
            <span>Jewellers</span>
        </div>

        <nav class="nav-menu">
            <a href="index.html" class="nav-item">
                <i class="fa-solid fa-house"></i> Dashboard
            </a>
            <a href="stock.html" class="nav-item">
                <i class="fa-solid fa-gem"></i> Stock Management
            </a>
            <a href="invoice.html" class="nav-item active">
                <i class="fa-solid fa-file-invoice"></i> Create Invoice
            </a>
            <a href="all-invoices.html" class="nav-item">
                <i class="fa-solid fa-archive"></i> Invoice Archive
            </a>
        </nav>
    </aside>
<main class="main-content">
    <div id="globalLoader" style="display:none;">
        <div class="loader-overlay"><div class="spinner"></div></div>
    </div>

    <form id="invoiceForm" onsubmit="return false;">
        <div class="invoice-box">
            <div class="row-header">
                <div class="logo-box" style="flex-shrink: 0;">
                    <img src="logo.jpg" alt="Company Logo" style="height: 80px;">
                </div>
                <div class="shop-info">
                    <h1>Ranka Jewellers</h1>
                    <p>62 Lohiya Marg, Shujalpur Mandi (Near Rokadiya Hanuman Mandir), Shujalpur, MP </p>
                        <p> Ph: +91 9425035298, +91 9406864568</p>
                    <p style="font-size: 10px; color: #999;">GSTIN: 23AOGPR7500E1Z8</p>
                </div>
                
            </div>
            <div class="inv-meta-bar">
                    <div>Date: <input type="date" id="invDate" required></div>
                    <div>Invoice No: <input type="text" id="invNum" readonly></div>
                </div>
            <div class="info-grid">
                <div>
                    <span class="section-label">Customer Name*</span>
                    <input type="text" id="custName" placeholder="Enter Full Name" required>
                    <div style="margin-top: 12px;">
                        <span class="section-label">Phone Number</span>
                        <input type="text" id="custPhone" placeholder="+91">
                    </div>
                </div>
                <div>
                    <span class="section-label">Address</span>
                    <textarea id="custAddress" rows="3" placeholder="Address"></textarea>
                </div>
            </div>

            <div class="live-rates">
                <span class="section-label" style="margin:0">Market Rates (1g):</span>
                Gold 22k: ₹<input type="number" id="goldRate" placeholder="0" oninput="calculate()" style="width:110px" required>
                Silver: ₹<input type="number" id="silverRate" placeholder="0" oninput="calculate()" style="width:100px" required>
            </div>

            <table>
                <colgroup>
                    <col style="width:2%">
                    <col style="width:16%">
                    <col style="width:12%">
                    <col style="width:12%">
                    <col style="width:6%">
                    <col style="width:12%">
                    <col style="width:10%">
                    <col style="width:10%">
                    <col style="width:7%">
                    <col style="width:10%">
                    <col style="width:2%">
                </colgroup>

                <thead>
                    <tr>
                        <th width="2%">#</th>
                        <th width="16%">Description</th>
                        <th width="12%">HSN</th>
                        <th width="12%">Metal</th>
                        <th width="10%">Purity</th>
                        <th width="12%">Qty</th>
                        <th width="10%">Gross Weight (gms)</th>
                        <th width="10%">Net Weight (gms)</th>
                        <th width="10%">Making</th>
                        <th width="10%">Total</th>
                        <th width="2%" class="no-print"></th>
                    </tr>
                </thead>
                <tbody id="itemBody"></tbody>
            </table>
            <datalist id="stockSuggestions"></datalist>
            <datalist id="hsnSuggestions"></datalist>

            <div class="btn-group no-print">
                <button type="button" class="btn btn-add" onclick="addRow()">+ Add New Item</button>
                <button type="button" class="btn btn-save" onclick="saveInvoice()">Save & Print</button>
                <!-- <button type="button" class="btn btn-print" onclick="window.print()">Print Receipt</button> -->
            </div>

            <div class="footer-section">
                <div>
                    <span class="section-label">Terms & Conditions</span>
                    <ul style="font-size: 10px; color: #777; padding-left: 15px; margin: 5px 0;">
                        <li>Goods once sold will not be taken back.</li>
                        <li>Purity is guaranteed as per hallmark standards.</li>
                        <li>Subject to Shujalpur Jurisdiction.</li>
                    </ul>
                    <div class="amount-words">
                        Total: <span id="totalInWords">Zero Rupees Only</span>
                    </div>
                    <div class="bank-details-box">
                         <div class="bank-qr">
                            <img src="phonePay.jpg" alt="PhonePe QR">
                            <span class="qr-text">Scan & Pay</span>
                        </div>
                        <div class="bank-left">
                            <span class="bank-details-title">Bank Details:</span>
                            <span><strong>Bank:</strong> Bank of India</span>
                            <span><strong>A/c Name:</strong> Ranka Jewellers</span>
                            <span><strong>A/c No:</strong> 955420110000385</span>
                            <span><strong>IFSC:</strong> BKID0009554</span>
                        </div>
                        
                    </div>
                    
                    <div class="signature-box" style="text-align: left;">
                        <span class="signature-line"></span>
                        <span class="sign-label">Customer Signature</span>
                    </div>
                </div>
                
                <div class="summary-table">
                    <div><span>Subtotal:</span> <span id="subtotal">₹0.00</span></div>
                    <div><span>CGST (1.5%):</span> <span id="cgst">₹0.00</span></div>
                    <div><span>IGST (1.5%):</span> <span id="sgst">₹0.00</span></div>
                    
                    <div class="grand-total-row"><span>Grand Total:</span> <span id="grandTotal">₹0.00</span></div>
                    
                    <div style="background: #f0fff4; padding: 8px; border-radius: 6px; margin-top: 5px;">
                        <span>Cash Received:</span> 
                        <input type="number" id="cashReceived" value="0" oninput="calculate()" style="background: transparent; text-align: right; width: 100px; font-weight: bold; border:none; border-bottom: 1px solid #27ae60;">
                    </div>
                    
                    <div style="color: #e74c3c; font-weight: 600; padding: 10px 0;">
                        <span>Balance Due:</span> <span id="balanceDue">₹0.00</span>
                    </div>
                    
                    <div class="signature-box" style="text-align: right;">
                        <p style="margin: 0; font-weight: bold; font-size: 11px; text-transform: uppercase;">For Ranka Jewellers</p>
                        <div style="height: 40px;"></div>
                        <span class="sign-label">Authorized Signatory</span>
                    </div>
                </div>
            </div>

        </div>
    </form>
</main>

<script>
window.onload = function() {
    loadStockSuggestions();
    const editData = sessionStorage.getItem('editInvoiceData');
    if (editData) {
        try {
            const inv = JSON.parse(editData);
            populateInvoiceFields(inv);
            sessionStorage.removeItem('editInvoiceData');
        } catch (e) { initNewInvoice(); }
    } else { initNewInvoice(); }
};

function initNewInvoice() {
    document.getElementById('invDate').valueAsDate = new Date();
    updateInvoiceDisplay();
    const storedRates = JSON.parse(sessionStorage.getItem('lastUsedRates'));
    if (storedRates) {
        if (parseFloat(storedRates.gold) > 0) document.getElementById('goldRate').value = storedRates.gold;
        if (parseFloat(storedRates.silver) > 0) document.getElementById('silverRate').value = storedRates.silver;
    }
}

function populateInvoiceFields(inv) {
    document.getElementById('invNum').value = inv.invoiceNumber;
    document.getElementById('invDate').value = inv.date;
    document.getElementById('custName').value = inv.customer.name;
    document.getElementById('custPhone').value = inv.customer.phone;
    document.getElementById('custAddress').value = inv.customer.address;
    document.getElementById('goldRate').value = inv.rates.gold;
    document.getElementById('silverRate').value = inv.rates.silver;
    document.getElementById('cashReceived').value = inv.summary.cashReceived || 0;
    const tbody = document.getElementById('itemBody');
    tbody.innerHTML = '';
    inv.items.forEach(item => { addRow(item); });
    calculate(); 
}

function updateInvoiceDisplay() {
    const currentYear = new Date().getFullYear();
    fetch('/invoices/count')
        .then(response => response.json())
        .then(data => {
            let currentNum = (data.data || 0) + 1;
            document.getElementById('invNum').value = `RJ/${currentYear}/${currentNum.toString().padStart(3, '0')}`;
        })
        .catch(() => {
            document.getElementById('invNum').value = `RJ/${currentYear}/001`;
        });
}

// Function to update S.No for all rows
function updateRowIndices() {
    const rows = document.querySelectorAll('#itemBody tr');
    rows.forEach((row, index) => {
        row.querySelector('.row-index').innerText = index + 1;
    });
}

function addRow(itemData = null) {
    const existingRows = document.querySelectorAll('#itemBody tr'); 
    let previousHsn = '';

    if (existingRows.length > 0) {
        const lastRow = existingRows[existingRows.length - 1];
        const hsnInput = lastRow.querySelector('.item-hsn');
        if (hsnInput) {
            previousHsn = hsnInput.value;
        }
    }

    // Priority: itemData.hsn > previousHsn > empty string
    const hsnToUse = (itemData && itemData.hsn) ? itemData.hsn : previousHsn;

    const tr = document.createElement('tr');
    tr.innerHTML = `
        <td style="font-weight: 600; color: var(--gold-primary); text-align: center;"><span class="row-index"></span></td>
        <td><input type="text" value="${itemData ? itemData.description : ''}" placeholder="Item" list="stockSuggestions" required></td>
        <td><input type="text" class="item-hsn" value="${hsnToUse}" placeholder="HSN" list="hsnSuggestions"></td>
        <td>
            <select class="type type-select ${itemData && itemData.metal === 'silver' ? 'silver-theme' : 'gold-theme'}" onchange="updateTheme(this,true); calculate()">
                <option value="gold" ${itemData && itemData.metal === 'gold' ? 'selected' : ''}>GOLD</option>
                <option value="silver" ${itemData && itemData.metal === 'silver' ? 'selected' : ''}>SILVER</option>
            </select>
        </td>
        <td><input type="text" class="item-purity" value="${itemData ? itemData.purity : "22K"}" readonly></td>
        <td><input type="number" class="item-qty" value="${itemData ? itemData.qty : '1'}" oninput="calculate()"></td>
        <td><input type="number" required class="weight gWeight" value="${itemData ? itemData.gWeight : ''}" placeholder="0.000" step="0.001" oninput="syncNetWeight(this)"></td>
        <td><input type="number" required class="weight nWeight" value="${itemData ? itemData.weight : ''}" placeholder="0.000" step="0.001" oninput="calculate()"></td>
        <td><input type="number" class="making-val-input making-val" value="${itemData ? itemData.makingCharge : '12'}" oninput="calculate()">%</td>
        <td>₹<span class="row-total">${itemData ? itemData.total.toFixed(2) : '0.00'}</span></td>
        <td class="no-print"><button type="button" onclick="this.parentElement.parentElement.remove(); updateRowIndices(); calculate();" style="color:#e74c3c; background:none; border:none; cursor:pointer; font-weight:bold;">✕</button></td>
    `;
    document.getElementById('itemBody').appendChild(tr);
    updateRowIndices();
    const typeSelect = tr.querySelector('.type-select');
    updateTheme(typeSelect);
    if(itemData) calculate();
}

function syncNetWeight(grossInput) {
    const row = grossInput.closest('tr');
    const netInput = row.querySelector('.nWeight');
    netInput.value = grossInput.value;
    calculate();
}
function updateTheme(selectEl, isManual = false) {
    const row = selectEl.closest('tr');
    const purityInput = row.querySelector('.item-purity');
    const makingInput = row.querySelector('.making-val'); 

    if (selectEl.value === 'silver') {
        selectEl.className = 'type type-select silver-theme';
        purityInput.style.visibility = 'hidden';
        // Only reset to 0 if the user manually changed the dropdown
        if (isManual) makingInput.value = '0'; 
    } else {
        selectEl.className = 'type type-select gold-theme';
        purityInput.style.visibility = 'visible';
        // Only reset to 12 if the user manually changed the dropdown
        if (isManual) makingInput.value = '12'; 
    }
}
function calculate() {
    const gRate = parseFloat(document.getElementById('goldRate').value) || 0;
    const sRate = parseFloat(document.getElementById('silverRate').value) || 0;
    let totalTaxable = 0;

    document.querySelectorAll('#itemBody tr').forEach(row => {
        const type = row.querySelector('.type').value;
        const weight = parseFloat(row.querySelector('.nWeight').value) || 0;
        const qty = parseFloat(row.querySelector('.item-qty').value) || 0;

        let rate = (type === 'gold') ? gRate : sRate;

        const makingPercent = (parseFloat(row.querySelector('.making-val').value) || 0) / 100; 
        const makingCharge = (weight * qty) * rate * makingPercent;

        const rowTotal = (weight * qty) * rate + makingCharge;
        row.querySelector('.making-val').innerText = (type === 'gold') ? 12 : 0;
        row.querySelector('.row-total').innerText = rowTotal.toFixed(2);
        totalTaxable += rowTotal;
    });

    const cgst = totalTaxable * 0.015;
    const sgst = totalTaxable * 0.015;
    const finalGrandTotal = Math.round(totalTaxable + cgst + sgst);
    const cash = parseFloat(document.getElementById('cashReceived').value) || 0;

    document.getElementById('subtotal').innerText = "₹" + totalTaxable.toLocaleString('en-IN', {minimumFractionDigits: 2});
    document.getElementById('cgst').innerText = "₹" + cgst.toLocaleString('en-IN', {minimumFractionDigits: 2});
    document.getElementById('sgst').innerText = "₹" + sgst.toLocaleString('en-IN', {minimumFractionDigits: 2});
    document.getElementById('grandTotal').innerText = "₹" + finalGrandTotal.toLocaleString('en-IN');
    document.getElementById('balanceDue').innerText = "₹" + (finalGrandTotal - cash).toLocaleString('en-IN');
    document.getElementById('totalInWords').innerText = priceToWords(finalGrandTotal) + " Rupees Only";
    
    const gold = document.getElementById('goldRate').value;
    const silver = document.getElementById('silverRate').value;
    sessionStorage.setItem('lastUsedRates', JSON.stringify({ gold, silver }));
}

function priceToWords(num) {
    const a = ['', 'One ', 'Two ', 'Three ', 'Four ', 'Five ', 'Six ', 'Seven ', 'Eight ', 'Nine ', 'Ten ', 'Eleven ', 'Twelve ', 'Thirteen ', 'Fourteen ', 'Fifteen ', 'Sixteen ', 'Seventeen ', 'Eighteen ', 'Nineteen '];
    const b = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
    if ((num = num.toString()).length > 9) return 'Overflow';
    let n = ('000000000' + num).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
    if (!n) return ''; 
    let str = '';
    str += (n[1] != 0) ? (a[Number(n[1])] || b[n[1][0]] + ' ' + a[n[1][1]]) + 'Crore ' : '';
    str += (n[2] != 0) ? (a[Number(n[2])] || b[n[2][0]] + ' ' + a[n[2][1]]) + 'Lakh ' : '';
    str += (n[3] != 0) ? (a[Number(n[3])] || b[n[3][0]] + ' ' + a[n[3][1]]) + 'Thousand ' : '';
    str += (n[4] != 0) ? (a[Number(n[4])] || b[n[4][0]] + ' ' + a[n[4][1]]) + 'Hundred ' : '';
    str += (n[5] != 0) ? ((str != '') ? 'and ' : '') + (a[Number(n[5])] || b[n[5][0]] + ' ' + a[n[5][1]]) : '';
    return str.trim() || 'Zero';
}

function startNewInvoice() {
    if(confirm("Discard current progress?")) {
        sessionStorage.removeItem('editInvoiceData');
        location.reload(); 
    }
}

async function loadStockSuggestions() {
    try {
        const response = await fetch('/stocks');
        const result = await response.json();
        const stocks = result.data || result; 

        const datalist = document.getElementById('stockSuggestions');
        datalist.innerHTML = '';
        const hsnList = document.getElementById('hsnSuggestions');
        hsnList.innerHTML='';
        
        stocks.items.forEach(stock => {
            const option = document.createElement('option');
            option.value = stock;
            datalist.appendChild(option);
        });
        
         stocks.hsnCodes.forEach(hsnCode => {            
            const hsnOption = document.createElement('option');
            hsnOption.value = hsnCode;
            hsnList.appendChild(hsnOption);
        });
    } catch (e) {}
}

function showLoader() { document.getElementById('globalLoader').style.display = 'block'; }
function hideLoader() { document.getElementById('globalLoader').style.display = 'none'; }

async function saveInvoice() {
    const form = document.getElementById('invoiceForm');
    if (!form.reportValidity()) return;

    const gold = document.getElementById('goldRate').value;
    const silver = document.getElementById('silverRate').value;

    const invoice = {
        invoiceNumber: document.getElementById('invNum').value,
        date: document.getElementById('invDate').value,
        customer: {
            name: document.getElementById('custName').value,
            phone: document.getElementById('custPhone').value,
            address: document.getElementById('custAddress').value
        },
        rates: { gold: parseFloat(gold), silver: parseFloat(silver) },
        items: Array.from(document.querySelectorAll('#itemBody tr')).map(row => ({
            description: row.querySelector('td input').value,
            hsn: row.querySelector('.item-hsn').value,
            metal: row.querySelector('.type').value,
            qty: parseFloat(row.querySelector('.item-qty').value),
            purity: row.querySelector('.item-purity').value,
            weight: parseFloat(row.querySelector('.nWeight').value),
            gWeight: parseFloat(row.querySelector('.gWeight').value),
            makingCharge: parseFloat(row.querySelector('.making-val').value),
            total: parseFloat(row.querySelector('.row-total').innerText)
        })),
        summary: {
            subtotal: parseFloat(document.getElementById('subtotal').innerText.replace(/₹|,/g,'')),
            cgst: parseFloat(document.getElementById('cgst').innerText.replace(/₹|,/g,'')),
            sgst: parseFloat(document.getElementById('sgst').innerText.replace(/₹|,/g,'')),
            grandTotal: parseFloat(document.getElementById('grandTotal').innerText.replace(/₹|,/g,'')),
            cashReceived: parseFloat(document.getElementById('cashReceived').value),
            balanceDue: parseFloat(document.getElementById('balanceDue').innerText.replace(/₹|,/g,'')),
            totalInWords: document.getElementById('totalInWords').innerText
        }
    };

    try {
        showLoader();
        const res = await fetch('/invoice', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(invoice)
        });
        if(res.ok) {
            sessionStorage.setItem('lastUsedRates', JSON.stringify({ gold, silver }));
            alert('Invoice saved successfully!');
            window.print();
        } else { alert('Failed to save.'); }
    } catch (e) { alert('Server Error.'); } finally { hideLoader(); }
}
</script>
</body>
</html>
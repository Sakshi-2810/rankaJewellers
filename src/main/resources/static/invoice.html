<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Invoice Center | Ranka Jewellers</title>
<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Dancing+Script:wght@600&family=Poppins:wght@300;400;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<style>
:root { 
    --gold: #d4af37;
    --gold-dark: #b8962e;
    --gold-primary: #b08d57;
    --gold-light: #f4ece1;

    --silver: #cfd2d6;
    --silver-dark: #9da3a8;

    --text-main: #2d3436;
    --bg-body: #f4f1ea;
    --dark-sidebar: #1a1a1a;

    --transition: all 0.35s ease;
}


* { box-sizing: border-box; font-family: 'Poppins', sans-serif; }

body { 
    display: flex;
    height: 100vh;
    margin: 0;
    background: var(--bg-body);
    color: var(--text-main);
    overflow: hidden; 
}
  /* ===== SIDEBAR ===== */
        .sidebar {
            width: 270px;
            background: linear-gradient(180deg, #0c0c0c, #1a1a1a);
            padding: 45px 0;
            display: flex;
            flex-direction: column;
            box-shadow: 8px 0 30px rgba(0,0,0,0.4);
        }

        .sidebar-brand {
            text-align: center;
            padding-bottom: 50px;
        }

        .sidebar-brand h1 {
            font-family: 'Great Vibes', cursive;
            font-size: 3rem;
            color: var(--gold);
            margin: 0;
            letter-spacing: 2px;
        }

        .sidebar-brand span {
            display: block;
            font-family: 'Playfair Display', serif;
            font-size: 0.75rem;
            letter-spacing: 4px;
            text-transform: uppercase;
            color: var(--silver);
            margin-top: 8px;
        }

        .nav-menu {
            padding: 0 20px;
            flex-grow: 1;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 14px 20px;
            border-radius: 14px;
            color: var(--silver);
            text-decoration: none;
            margin-bottom: 10px;
            transition: var(--transition);
            font-size: 0.9rem;
        }

        .nav-item i {
            font-size: 1.1rem;
            width: 22px;
            text-align: center;
        }

        .nav-item:hover {
            background: rgba(212,175,55,0.12);
            color: var(--gold);
        }

        .nav-item.active {
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: #fff;
            box-shadow: 0 10px 30px rgba(212,175,55,0.35);
        }

/* --- MAIN CONTENT --- */
.main-content { flex-grow: 1; overflow-y: auto; padding: 40px; }
.invoice-box { 
    max-width: 950px; margin: auto; padding: 40px; 
    background: #fff; border-radius: 12px; 
    box-shadow: 0 10px 30px rgba(0,0,0,0.05);
    border: 1px solid rgba(176, 141, 87, 0.2);
}

.row-header { text-align: center; border-bottom: 2px solid var(--gold-light); padding-bottom: 15px; margin-bottom: 15px; }
.shop-info h1 { font-family: 'Great Vibes', cursive; margin: 0; color: var(--gold-primary); font-size: 54px; font-weight: 400; }
.shop-info p { font-size: 11px; color: #636e72; margin: 2px 0; text-transform: uppercase; letter-spacing: 1px;}

.inv-meta-bar { display: flex; justify-content: space-between; margin-top: 10px; font-family: 'Dancing Script', cursive; font-size: 20px; color: var(--gold-primary); border-top: 1px solid var(--gold-light); padding-top: 10px; }
.inv-meta-bar input { border: none; font-weight: bold; background: transparent; width: 140px; font-size: 14px; font-family: 'Poppins'; }

.info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; }
.section-label { font-size: 10px; font-weight: 600; text-transform: uppercase; color: var(--gold-primary); letter-spacing: 1px; margin-bottom: 4px; display: block; }

input, textarea, select { width: 100%; border: 1px solid #edf2f7; padding: 8px; border-radius: 6px; font-size: 12px; }
input:required { border-left: 3px solid var(--gold-primary); }

.live-rates { background: var(--gold-light); padding: 12px; border-radius: 8px; display: flex; gap: 15px; align-items: center; margin-bottom: 15px; border: 1px solid #e2d1b8; }

table { width: 100%; border-collapse: collapse; margin: 10px 0; }
th { background: #fafbfc; padding: 10px; text-align: left; font-size: 10px; color: #a0aec0; text-transform: uppercase; border-bottom: 2px solid var(--gold-light); }
td { padding: 8px 10px; border-bottom: 1px solid #f1f4f8; }

.gold-theme { background-color: #fffcf0 !important; color: #8a6d07 !important; border: 1px solid var(--gold-primary) !important; font-weight: 600; }
.silver-theme { background-color: #f8fafc !important; color: #4a5568 !important; border: 1px solid #ddd !important; }

.footer-section { display: grid; grid-template-columns: 1.2fr 1fr; gap: 40px; margin-top: 20px; }
.amount-words { margin: 15px 0; padding: 12px; background: var(--gold-light); border-radius: 8px; font-family: 'Dancing Script', cursive; font-size: 18px; color: #8a6d07; border-left: 5px solid var(--gold-primary); }

.summary-table div { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #f1f4f8; }
.grand-total-row { font-size: 22px; font-weight: 600; color: var(--gold-primary); border-top: 2px solid var(--gold-primary) !important; padding: 10px 0 !important; }

.signature-box { margin-top: 40px; text-align: center; }
.signature-line { border-top: 1px solid #333; width: 160px; display: inline-block; }
.sign-label { font-family: 'Dancing Script', cursive; font-size: 18px; display: block; color: #8a6d07; }

.btn-group { display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; margin-top: 25px; }
.btn { padding: 10px 20px; border-radius: 50px; cursor: pointer; border: none; font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; transition: 0.2s; text-decoration: none; display: inline-block; text-align: center;}
.btn-add { background: var(--gold-primary); color: white; }
.btn-print { background: #2d3436; color: white; }
.btn-save { background: #27ae60; color: white; }

#globalLoader .loader-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center; }
.spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--gold-primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
@page {
    size: A4;
    margin: 0; 
}

@media print {

    * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
    html, body {
        overflow: hidden !important;
    }

    .main-content,
    .invoice-box {
        overflow: visible !important;
    }

    body {
        background: white !important;
        margin: 0;
        padding: 0;
    }

    .sidebar, .no-print, .btn-group {
        display: none !important;
    }

    .main-content {
        padding: 0;
    }

    .invoice-box {
        position: relative;
        z-index: 1;
        padding: 1.5cm;
        width: 100%;
        min-height: 29.7cm;
        background: transparent !important;
        box-shadow: none;
        border: none;
    }

    /* üñãÔ∏è ELEGANT LINE ART BACKGROUND */
    .invoice-box::before {
        content: "";
        position: absolute;
        inset: 0;
        z-index: -1;
        pointer-events: none;

        background:
            /* Diamond lattice */
            repeating-linear-gradient(
                45deg,
                rgba(0,0,0,0.025) 0,
                rgba(0,0,0,0.025) 1px,
                transparent 1px,
                transparent 12px
            ),
            repeating-linear-gradient(
                -45deg,
                rgba(0,0,0,0.025) 0,
                rgba(0,0,0,0.025) 1px,
                transparent 1px,
                transparent 12px
            ),
            /* Soft paper texture */
            linear-gradient(180deg, #ffffff 0%, #fafafa 100%);
    }

    /* ‚õìÔ∏è DOUBLE ORNAMENT BORDER */
    .invoice-box::after {
        content: "";
        position: absolute;
        top: 10mm;
        left: 10mm;
        right: 10mm;
        bottom: 10mm;
        pointer-events: none;

        border: 1.2px solid rgba(0,0,0,0.45);
        outline: 0.8px solid rgba(0,0,0,0.25);
        outline-offset: -8px;
        border-radius: 6px;
    }

    /* üåø CORNER DECORATION FEEL */
    .invoice-box::marker {
        display: none;
    }

    /* ü™ô WATERMARK (TEXT SAFE) */
    .invoice-watermark {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 72px;
        letter-spacing: 8px;
        font-family: "Playfair Display", serif;
        color: rgba(0,0,0,0.04);
        z-index: -1;
        white-space: nowrap;
    }

    input, select, textarea {
        border: none !important;
        background: transparent !important;
        color: black !important;
        appearance: none;
    }

    .amount-words {
        background: rgba(0,0,0,0.04) !important;
        border: 1px dashed rgba(0,0,0,0.3);
    }
}
/* 1. Remove the up/down arrows (spinners) to free up horizontal space */
.weight::-webkit-outer-spin-button,
.weight::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

.weight[type=number] {
    -moz-appearance: textfield; /* Firefox fix */
}

/* 2. Reduce horizontal padding and ensure the font fits */
.weight {
    padding-left: 4px !important;
    padding-right: 4px !important;
    text-align: center; /* Optional: centers the value for better visibility */
}

/* 3. Ensure the table column has enough room (Overriding the 10% if needed) */
th:nth-child(5), 
td:nth-child(5) {
    min-width: 85px !important; 
}
/* ===== RESPONSIVE MEDIA QUERIES ===== */

/* Tablet View (up to 1024px) */
@media screen and (max-width: 1024px) {
    body {
        flex-direction: column;
        overflow-y: auto;
    }

    .sidebar {
        width: 100%;
        height: auto;
        padding: 20px 0;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .sidebar-brand {
        padding-bottom: 0;
        padding-left: 30px;
        text-align: left;
    }

    .sidebar-brand h1 { font-size: 2rem; }

    .nav-menu {
        display: flex;
        padding: 0 20px;
        gap: 8px;
    }

    .nav-item {
        margin-bottom: 0;
        padding: 10px 15px;
        font-size: 0.8rem;
    }

    .main-content {
        padding: 20px;
    }

    .invoice-box {
        padding: 25px;
        width: 100%;
    }
}

/* Mobile View (up to 768px) */
@media screen and (max-width: 768px) {
    .sidebar {
        flex-direction: column;
        gap: 10px;
    }

    .nav-menu {
        width: 100%;
        overflow-x: auto;
        padding: 5px 15px;
        justify-content: flex-start;
    }

    /* Stack Info Grid (Customer Details) */
    .info-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }

    /* Live Rates wrapping */
    .live-rates {
        flex-wrap: wrap;
        justify-content: center;
        font-size: 12px;
    }

    /* Table Responsiveness: Enable horizontal scroll */
    .invoice-box {
        overflow-x: hidden; /* Prevent box from breaking */
    }

    table {
        display: block;
        overflow-x: auto;
        white-space: nowrap; /* Keeps columns from squishing */
        -webkit-overflow-scrolling: touch;
    }

    /* Stack Footer (Terms and Summary) */
    .footer-section {
        grid-template-columns: 1fr;
        gap: 20px;
    }

    .shop-info h1 {
        font-size: 40px;
    }

    .grand-total-row {
        font-size: 18px;
    }

    .inv-meta-bar {
        flex-direction: column;
        gap: 10px;
        align-items: center;
    }
}

/* Adjustments for small phones */
@media screen and (max-width: 480px) {
    .btn-group {
        flex-direction: column;
    }
    
    .btn {
        width: 100%;
    }
}
</style>
</head>
<body>

  <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="sidebar-brand">
            <h1>Ranka</h1>
            <span>Jewellers</span>
        </div>

        <nav class="nav-menu">
            <a href="index.html" class="nav-item">
                <i class="fa-solid fa-house"></i> Dashboard
            </a>
            <a href="stock.html" class="nav-item">
                <i class="fa-solid fa-gem"></i> Stock Management
            </a>
            <a href="invoice.html" class="nav-item active">
                <i class="fa-solid fa-file-invoice"></i> Create Invoice
            </a>
            <a href="all-invoices.html" class="nav-item">
                <i class="fa-solid fa-archive"></i> Invoice Archive
            </a>
        </nav>
    </aside>
<main class="main-content">
    <div id="globalLoader" style="display:none;">
        <div class="loader-overlay"><div class="spinner"></div></div>
    </div>

    <form id="invoiceForm" onsubmit="return false;">
        <div class="invoice-box">
            <div class="row-header">
                <div class="shop-info">
                    <h1>Ranka Jewellers</h1>
                    <p>62 Lohiya Marg, Shujalpur Mandi (Near Rokadiya Hanuman Mandir), Shujalpur, MP </p>
                        <p> Ph: +91 9425035298, +91 9406864568</p>
                    <p style="font-size: 10px; color: #999;">GSTIN: 23ABCDE1234F1Z5</p>
                </div>
                <div class="inv-meta-bar">
                    <div>Date: <input type="date" id="invDate" required></div>
                    <div>Invoice No: <input type="text" id="invNum" readonly></div>
                </div>
            </div>

            <div class="info-grid">
                <div>
                    <span class="section-label">Customer Name*</span>
                    <input type="text" id="custName" placeholder="Enter Full Name" required>
                    <div style="margin-top: 12px;">
                        <span class="section-label">Phone Number</span>
                        <input type="text" id="custPhone" placeholder="+91">
                    </div>
                </div>
                <div>
                    <span class="section-label">Address</span>
                    <textarea id="custAddress" rows="3" placeholder="Address"></textarea>
                </div>
            </div>

            <div class="live-rates no-print">
                <span class="section-label" style="margin:0">Market Rates (1g):</span>
                Gold 24k: <input type="number" id="goldRate" value="0" oninput="calculate()" style="width:110px" required>
                Silver: <input type="number" id="silverRate" value="0" oninput="calculate()" style="width:100px" required>
            </div>

            <table>
                <thead>
                    <tr>
                        <th width="5%">#</th>
                        <th width="17%">Description</th>
                        <th width="12%">Metal</th>
                        <th width="12%">Purity</th>
                        <th width="10%">Weight (gms)</th>
                        <th width="14%">Metal Value</th>
                        <th width="12%">Making (12%)</th>
                        <th width="14%">Total</th>
                        <th width="4%" class="no-print"></th>
                    </tr>
                </thead>
                <tbody id="itemBody"></tbody>
            </table>
            <datalist id="stockSuggestions"></datalist>

            <div class="btn-group no-print">
                <button type="button" class="btn btn-add" onclick="addRow()">+ Add New Item</button>
                <button type="button" class="btn btn-save" onclick="saveInvoice()">Save to Vault</button>
                <button type="button" class="btn btn-print" onclick="window.print()">Print Receipt</button>
            </div>

            <div class="footer-section">
                <div>
                    <span class="section-label">Terms & Conditions</span>
                    <ul style="font-size: 10px; color: #777; padding-left: 15px; margin: 5px 0;">
                        <li>Goods once sold will not be taken back.</li>
                        <li>Purity is guaranteed as per hallmark standards.</li>
                        <li>Subject to Shujalpur Jurisdiction.</li>
                    </ul>
                    <div class="amount-words">
                        Total: <span id="totalInWords">Zero Rupees Only</span>
                    </div>
                    
                    <div class="signature-box" style="text-align: left;">
                        <span class="signature-line"></span>
                        <span class="sign-label">Customer Signature</span>
                    </div>
                </div>
                
                <div class="summary-table">
                    <div><span>Subtotal:</span> <span id="subtotal">‚Çπ0.00</span></div>
                    <div><span>CGST (1.5%):</span> <span id="cgst">‚Çπ0.00</span></div>
                    <div><span>IGST (1.5%):</span> <span id="sgst">‚Çπ0.00</span></div>
                    
                    <div class="grand-total-row"><span>Grand Total:</span> <span id="grandTotal">‚Çπ0.00</span></div>
                    
                    <div style="background: #f0fff4; padding: 8px; border-radius: 6px; margin-top: 5px;" class="no-print">
                        <span>Cash Received:</span> 
                        <input type="number" id="cashReceived" value="0" oninput="calculate()" style="background: transparent; text-align: right; width: 100px; font-weight: bold; border:none; border-bottom: 1px solid #27ae60;">
                    </div>
                    
                    <div style="color: #e74c3c; font-weight: 600; padding: 10px 0;">
                        <span>Balance Due:</span> <span id="balanceDue">‚Çπ0.00</span>
                    </div>
                    
                    <div class="signature-box" style="text-align: right;">
                        <p style="margin: 0; font-weight: bold; font-size: 11px; text-transform: uppercase;">For Ranka Jewellers</p>
                        <div style="height: 40px;"></div>
                        <span class="sign-label">Authorized Signatory</span>
                    </div>
                </div>
            </div>
        </div>
    </form>
</main>

<script>
window.onload = function() {
    loadStockSuggestions();
    const editData = sessionStorage.getItem('editInvoiceData');
    if (editData) {
        try {
            const inv = JSON.parse(editData);
            populateInvoiceFields(inv);
            sessionStorage.removeItem('editInvoiceData');
        } catch (e) { initNewInvoice(); }
    } else { initNewInvoice(); }
};

function initNewInvoice() {
    document.getElementById('invDate').valueAsDate = new Date();
    updateInvoiceDisplay();
    const storedRates = JSON.parse(sessionStorage.getItem('lastUsedRates'));
    if (storedRates) {
        if (parseFloat(storedRates.gold) > 0) document.getElementById('goldRate').value = storedRates.gold;
        if (parseFloat(storedRates.silver) > 0) document.getElementById('silverRate').value = storedRates.silver;
    }
    addRow(); 
}

function populateInvoiceFields(inv) {
    document.getElementById('invNum').value = inv.invoiceNumber;
    document.getElementById('invDate').value = inv.date;
    document.getElementById('custName').value = inv.customer.name;
    document.getElementById('custPhone').value = inv.customer.phone;
    document.getElementById('custAddress').value = inv.customer.address;
    document.getElementById('goldRate').value = inv.rates.gold;
    document.getElementById('silverRate').value = inv.rates.silver;
    document.getElementById('cashReceived').value = inv.summary.cashReceived || 0;
    const tbody = document.getElementById('itemBody');
    tbody.innerHTML = '';
    inv.items.forEach(item => { addRow(item); });
    calculate(); 
}

function updateInvoiceDisplay() {
    const currentYear = new Date().getFullYear();
    fetch('/invoices/count')
        .then(response => response.json())
        .then(data => {
            let currentNum = (data.data || 0) + 1;
            document.getElementById('invNum').value = `RJ/${currentYear}/${currentNum.toString().padStart(3, '0')}`;
        })
        .catch(() => {
            document.getElementById('invNum').value = `RJ/${currentYear}/001`;
        });
}

// Function to update S.No for all rows
function updateRowIndices() {
    const rows = document.querySelectorAll('#itemBody tr');
    rows.forEach((row, index) => {
        row.querySelector('.row-index').innerText = index + 1;
    });
}

function addRow(itemData = null) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
        <td style="font-weight: 600; color: var(--gold-primary); text-align: center;"><span class="row-index"></span></td>
        <td><input type="text" value="${itemData ? itemData.description : ''}" placeholder="Item" list="stockSuggestions" required></td>
        <td>
            <select class="type type-select ${itemData && itemData.metal === 'silver' ? 'silver-theme' : 'gold-theme'}" onchange="updateTheme(this); calculate()">
                <option value="gold" ${itemData && itemData.metal === 'gold' ? 'selected' : ''}>GOLD</option>
                <option value="silver" ${itemData && itemData.metal === 'silver' ? 'selected' : ''}>SILVER</option>
            </select>
        </td>
        <td>
            <select class="purity" onchange="calculate()" style="visibility: ${itemData && itemData.metal === 'silver' ? 'hidden' : 'visible'}">
                <option value="1" ${itemData && itemData.purity === 1 ? 'selected' : ''}>24k</option>
                <option value="0.916" ${itemData ? (itemData.purity === 0.916 ? 'selected' : '') : 'selected'}>22k</option>
                <option value="0.75" ${itemData && itemData.purity === 0.75 ? 'selected' : ''}>18k</option>
            </select>
        </td>
        <td><input type="number" required class="weight" value="${itemData ? itemData.weight : ''}" placeholder="0.000" step="0.001" oninput="calculate()"></td>
        <td>‚Çπ<span class="m-val">${itemData ? itemData.metalValue.toFixed(2) : '0.00'}</span></td>
        <td>‚Çπ<span class="making-val">${itemData ? itemData.makingCharge.toFixed(2) : '0.00'}</span></td>
        <td>‚Çπ<span class="row-total">${itemData ? itemData.total.toFixed(2) : '0.00'}</span></td>
        <td class="no-print"><button type="button" onclick="this.parentElement.parentElement.remove(); updateRowIndices(); calculate();" style="color:#e74c3c; background:none; border:none; cursor:pointer; font-weight:bold;">‚úï</button></td>
    `;
    document.getElementById('itemBody').appendChild(tr);
    updateRowIndices(); // Re-index after adding
}

function updateTheme(selectEl) {
    const puritySelect = selectEl.closest('tr').querySelector('.purity');
    if (selectEl.value === 'silver') {
        selectEl.className = 'type type-select silver-theme';
        puritySelect.style.visibility = 'hidden';
    } else {
        selectEl.className = 'type type-select gold-theme';
        puritySelect.style.visibility = 'visible';
    }
}

function calculate() {
    const gRate = parseFloat(document.getElementById('goldRate').value) || 0;
    const sRate = parseFloat(document.getElementById('silverRate').value) || 0;
    let totalTaxable = 0;

    document.querySelectorAll('#itemBody tr').forEach(row => {
        const type = row.querySelector('.type').value;
        const weight = parseFloat(row.querySelector('.weight').value) || 0;
        const purity = parseFloat(row.querySelector('.purity').value);
        let rate = (type === 'gold') ? gRate * purity : sRate;
        const metalVal = weight * rate;
        const makingCharge = metalVal * 0.12;
        const rowTotal = metalVal + makingCharge;
        row.querySelector('.m-val').innerText = metalVal.toFixed(2);
        row.querySelector('.making-val').innerText = makingCharge.toFixed(2);
        row.querySelector('.row-total').innerText = rowTotal.toFixed(2);
        totalTaxable += rowTotal;
    });

    const cgst = totalTaxable * 0.015;
    const sgst = totalTaxable * 0.015;
    const finalGrandTotal = Math.round(totalTaxable + cgst + sgst);
    const cash = parseFloat(document.getElementById('cashReceived').value) || 0;

    document.getElementById('subtotal').innerText = "‚Çπ" + totalTaxable.toLocaleString('en-IN', {minimumFractionDigits: 2});
    document.getElementById('cgst').innerText = "‚Çπ" + cgst.toLocaleString('en-IN', {minimumFractionDigits: 2});
    document.getElementById('sgst').innerText = "‚Çπ" + sgst.toLocaleString('en-IN', {minimumFractionDigits: 2});
    document.getElementById('grandTotal').innerText = "‚Çπ" + finalGrandTotal.toLocaleString('en-IN');
    document.getElementById('balanceDue').innerText = "‚Çπ" + (finalGrandTotal - cash).toLocaleString('en-IN');
    document.getElementById('totalInWords').innerText = priceToWords(finalGrandTotal) + " Rupees Only";
    
    const gold = document.getElementById('goldRate').value;
    const silver = document.getElementById('silverRate').value;
    sessionStorage.setItem('lastUsedRates', JSON.stringify({ gold, silver }));
}

function priceToWords(num) {
    const a = ['', 'One ', 'Two ', 'Three ', 'Four ', 'Five ', 'Six ', 'Seven ', 'Eight ', 'Nine ', 'Ten ', 'Eleven ', 'Twelve ', 'Thirteen ', 'Fourteen ', 'Fifteen ', 'Sixteen ', 'Seventeen ', 'Eighteen ', 'Nineteen '];
    const b = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
    if ((num = num.toString()).length > 9) return 'Overflow';
    let n = ('000000000' + num).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
    if (!n) return ''; 
    let str = '';
    str += (n[1] != 0) ? (a[Number(n[1])] || b[n[1][0]] + ' ' + a[n[1][1]]) + 'Crore ' : '';
    str += (n[2] != 0) ? (a[Number(n[2])] || b[n[2][0]] + ' ' + a[n[2][1]]) + 'Lakh ' : '';
    str += (n[3] != 0) ? (a[Number(n[3])] || b[n[3][0]] + ' ' + a[n[3][1]]) + 'Thousand ' : '';
    str += (n[4] != 0) ? (a[Number(n[4])] || b[n[4][0]] + ' ' + a[n[4][1]]) + 'Hundred ' : '';
    str += (n[5] != 0) ? ((str != '') ? 'and ' : '') + (a[Number(n[5])] || b[n[5][0]] + ' ' + a[n[5][1]]) : '';
    return str.trim() || 'Zero';
}

function startNewInvoice() {
    if(confirm("Discard current progress?")) {
        sessionStorage.removeItem('editInvoiceData');
        location.reload(); 
    }
}

async function loadStockSuggestions() {
    try {
        const response = await fetch('/stocks');
        const result = await response.json();
        const stocks = result.data || result; 
        const datalist = document.getElementById('stockSuggestions');
        datalist.innerHTML = '';
        stocks.forEach(stock => {
            const option = document.createElement('option');
            option.value = stock;
            datalist.appendChild(option);
        });
    } catch (e) {}
}

function showLoader() { document.getElementById('globalLoader').style.display = 'block'; }
function hideLoader() { document.getElementById('globalLoader').style.display = 'none'; }

async function saveInvoice() {
    const form = document.getElementById('invoiceForm');
    if (!form.reportValidity()) return;

    const gold = document.getElementById('goldRate').value;
    const silver = document.getElementById('silverRate').value;

    const invoice = {
        invoiceNumber: document.getElementById('invNum').value,
        date: document.getElementById('invDate').value,
        customer: {
            name: document.getElementById('custName').value,
            phone: document.getElementById('custPhone').value,
            address: document.getElementById('custAddress').value
        },
        rates: { gold: parseFloat(gold), silver: parseFloat(silver) },
        items: Array.from(document.querySelectorAll('#itemBody tr')).map(row => ({
            description: row.querySelector('td input').value,
            metal: row.querySelector('.type').value,
            purity: parseFloat(row.querySelector('.purity').value),
            weight: parseFloat(row.querySelector('.weight').value),
            metalValue: parseFloat(row.querySelector('.m-val').innerText),
            makingCharge: parseFloat(row.querySelector('.making-val').innerText),
            total: parseFloat(row.querySelector('.row-total').innerText)
        })),
        summary: {
            subtotal: parseFloat(document.getElementById('subtotal').innerText.replace(/‚Çπ|,/g,'')),
            cgst: parseFloat(document.getElementById('cgst').innerText.replace(/‚Çπ|,/g,'')),
            sgst: parseFloat(document.getElementById('sgst').innerText.replace(/‚Çπ|,/g,'')),
            grandTotal: parseFloat(document.getElementById('grandTotal').innerText.replace(/‚Çπ|,/g,'')),
            cashReceived: parseFloat(document.getElementById('cashReceived').value),
            balanceDue: parseFloat(document.getElementById('balanceDue').innerText.replace(/‚Çπ|,/g,'')),
            totalInWords: document.getElementById('totalInWords').innerText
        }
    };

    try {
        showLoader();
        const res = await fetch('/invoice', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(invoice)
        });
        if(res.ok) {
            sessionStorage.setItem('lastUsedRates', JSON.stringify({ gold, silver }));
            alert('Invoice saved successfully!');
        } else { alert('Failed to save.'); }
    } catch (e) { alert('Server Error.'); } finally { hideLoader(); }
}
</script>
</body>
</html>